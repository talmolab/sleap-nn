"""Generate confidence maps."""

from typing import Dict, Iterator, List, Text

import torch
from torch.utils.data.datapipes.datapipe import IterDataPipe

from sleap_nn.data.utils import make_grid_vectors


def make_confmaps(
    points_batch: torch.Tensor, xv: torch.Tensor, yv: torch.Tensor, sigma: float
) -> torch.Tensor:
    """Make confidence maps from a batch of points for multiple instances.

    Args:
        points_batch: A tensor of points of shape `(batch_size, n_nodes, 2)` and dtype `torch.float32` where
            the last axis corresponds to (x, y) pixel coordinates on the image for each instance.
            These can contain NaNs to indicate missing points.
        xv: Sampling grid vector for x-coordinates of shape `(grid_width,)` and dtype
            `torch.float32`. This can be generated by
            `sleap.nn.data.utils.make_grid_vectors`.
        yv: Sampling grid vector for y-coordinates of shape `(grid_height,)` and dtype
            `torch.float32`. This can be generated by
            `sleap.nn.data.utils.make_grid_vectors`.
        sigma: Standard deviation of the 2D Gaussian distribution sampled to generate
            confidence maps.

    Returns:
        Confidence maps as a tensor of shape `(batch_size, n_nodes, grid_height, grid_width)` of
        dtype `torch.float32`.
    """
    batch_size, n_nodes, _ = points_batch.shape

    x = torch.reshape(points_batch[:, :, 0], (batch_size, n_nodes, 1, 1))
    y = torch.reshape(points_batch[:, :, 1], (batch_size, n_nodes, 1, 1))

    xv_reshaped = torch.reshape(xv, (1, 1, 1, -1))
    yv_reshaped = torch.reshape(yv, (1, 1, -1, 1))

    cm = torch.exp(-((xv_reshaped - x) ** 2 + (yv_reshaped - y) ** 2) / (2 * sigma**2))

    # Replace NaNs with 0.
    cm = torch.nan_to_num(cm)

    return cm


def make_multi_confmaps(
    points_batch: torch.Tensor, xv: torch.Tensor, yv: torch.Tensor, sigma: float
) -> torch.Tensor:
    """Make confidence maps for multiple instances through reduction.
    Args:
        points_batch: A tensor of shape `(batch_size, points, 2)` and dtype `tf.float32`
            containing instance points where the last axis corresponds to (x, y) pixel
            coordinates on the image. This must be rank-3 even if a single instance is
            present.
        xv: Sampling grid vector for x-coordinates of shape `(grid_width,)` and dtype
            `torch.float32`. This can be generated by
            `sleap.nn.data.utils.make_grid_vectors`.
        yv: Sampling grid vector for y-coordinates of shape `(grid_height,)` and dtype
            `torch.float32`. This can be generated by
            `sleap.nn.data.utils.make_grid_vectors`.
        sigma: Standard deviation of the 2D Gaussian distribution sampled to generate
            confidence maps.

    Returns:
        Confidence maps as a tensor of shape `(batch_size, n_nodes, grid_height, grid_width)` of
        dtype `torch.float32`.

        Each channel will contain the elementwise maximum of the confidence maps
        generated from all individual points for the associated node.

    """
    batch_size, n_nodes, _ = points_batch.shape
    h, w = xv.shape[0], yv.shape[0]
    cms = torch.zeros((batch_size, 1, h, w), dtype=torch.float32)
    points = points_batch.reshape(batch_size * n_nodes, 1, 2)
    for p in points:
        cm_instance = make_confmaps(p.unsqueeze(dim=0), xv, yv, sigma)
        cms = torch.maximum(cms, cm_instance)
    return cms


class MultiConfidenceMapGenerator(IterDataPipe):
    """IterDataPipe for generating multi-instance confidence maps.

    This IterDataPipe will generate confidence maps for examples from the input pipeline.
    Input examples must contain image of shape (frames, channels, crop_height, crop_width)
    and instance of shape (n_instances, 2).

    Attributes:
        source_dp: The input `IterDataPipe` with examples that contain an instance and
            an image.
        sigma: The standard deviation of the Gaussian distribution that is used to
            generate confidence maps. This defines the spread in units of the input image's grid.
        output_stride: The relative stride to use when generating confidence maps.
            A larger stride will generate smaller confidence maps.
        centroids: If `True`, generate confidence maps for centroids rather than
            instance points.
        image_key: The name of the key where the image (frames, channels, crop_height, crop_width) is.
        instance_key: The name of the key where the instance points (n_instances, 2) are.
    """

    def __init__(
        self,
        source_dp: IterDataPipe,
        sigma: int = 1.5,
        output_stride: int = 1,
        centroids: bool = True,
        image_key: str = "image",
        instance_key: str = "instances",
    ) -> None:
        """Initialize ConfidenceMapGenerator with input `IterDataPipe`, sigma, and output stride."""
        self.source_dp = source_dp
        self.sigma = sigma
        self.output_stride = output_stride
        self.centroids = centroids
        self.image_key = image_key
        self.instance_key = instance_key

    def __iter__(self) -> Iterator[Dict[str, torch.Tensor]]:
        """Generate confidence maps for each example."""
        for example in self.source_dp:
            if self.centroids:
                points = example["centroids"][
                    :, : example["num_instances"], :
                ]  # .unsqueeze(dim=0)
            else:
                points = example[self.instance_key]
                if not self.centroids and self.instance_key == "instances":
                    points = points.view(points.shape[0], -1, 2)

            width = example[self.image_key].shape[-1]
            height = example[self.image_key].shape[-2]

            xv, yv = make_grid_vectors(height, width, self.output_stride)

            confidence_maps = make_multi_confmaps(
                points,
                xv,
                yv,
                self.sigma * self.output_stride,
            )

            if self.centroids:
                example["centroids_confidence_maps"] = confidence_maps
            else:
                example["confidence_maps"] = confidence_maps
            yield example


class ConfidenceMapGenerator(IterDataPipe):
    """IterDataPipe for generating confidence maps.

    This IterDataPipe will generate confidence maps for examples from the input pipeline.
    Input examples must contain image of shape (frames, channels, crop_height, crop_width)
    and instance of shape (n_instances, 2).

    Attributes:
        source_dp: The input `IterDataPipe` with examples that contain an instance and
            an image.
        sigma: The standard deviation of the Gaussian distribution that is used to
            generate confidence maps.
        output_stride: The relative stride to use when generating confidence maps.
            A larger stride will generate smaller confidence maps.
        image_key: The name of the key where the image (frames, channels, crop_height, crop_width) is.
        instance_key: The name of the key where the instance points (n_instances, 2) are.
    """

    def __init__(
        self,
        source_dp: IterDataPipe,
        sigma: int = 1.5,
        output_stride: int = 1,
        image_key: str = "image",
        instance_key: str = "instances",
    ) -> None:
        """Initialize ConfidenceMapGenerator with input `IterDataPipe`, sigma, and output stride."""
        self.source_dp = source_dp
        self.sigma = sigma
        self.output_stride = output_stride
        self.image_key = image_key
        self.instance_key = instance_key

    def __iter__(self) -> Iterator[Dict[str, torch.Tensor]]:
        """Generate confidence maps for each example."""
        for example in self.source_dp:
            instance = example[self.instance_key]
            if self.instance_key == "instances":
                instance = instance.view(instance.shape[0], -1, 2)

            width = example[self.image_key].shape[-1]
            height = example[self.image_key].shape[-2]

            xv, yv = make_grid_vectors(height, width, self.output_stride)

            confidence_maps = make_confmaps(
                instance,
                xv,
                yv,
                self.sigma * self.output_stride,
            )  # (n_nodes, height, width)

            example["confidence_maps"] = confidence_maps
            yield example
